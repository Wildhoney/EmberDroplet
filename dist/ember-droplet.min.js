"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)}!function(t,e,i){var r=e.Mixin,n=e.String,s=e.computed,o=e.get,a=e.set,u=e.run,l=e.assign||e.merge,p={NONE:0,VALID:1,INVALID:2,DELETED:4,UPLOADED:8,FAILED:16},c={PATCH:"PATCH",POST:"POST",PUT:"PUT"},d="droplet/add-files",h=function(t){return"function"==typeof Array.from?Array.from(t):Array.prototype.slice.call(t)},f=e.Service.extend(e.Evented,{publish:function(){this.trigger.apply(this,arguments)},subscribe:function(){this.on.apply(this,arguments)},unsubscribe:function(){this.off.apply(this,arguments)}});e.Application.initializer({name:"load-services",initialize:function(t){var e=f.create();t.register("event-bus:current",e,{instantiate:!1}),t.inject("component","DropletEventBus","event-bus:current"),t.inject("controller","DropletEventBus","event-bus:current")}});var m=e.Object.extend({init:function(){this.statusType=p.NONE},getMIMEType:function(){return this.file.type||""},getFileSize:function(){return void 0!==this.file.size?this.file.size:1/0},setStatusType:function(t){this.set("statusType",Number(t))}}),g={PUSH:"push",SET:"set"},v={requestMethod:c.POST,maximumSize:1/0,maximumValidFiles:1/0,uploadImmediately:!1,includeXFileSize:!0,useArray:!1,mimeTypes:["image/jpeg","image/jpg","image/gif","image/png","image/tiff","image/bmp"],requestHeaders:{},requestPostData:{}},y=n.w("files.length files.@each.statusType"),A={URL_REQUIRED:"Droplet: You must specify the URL parameter when constructing your component."};t.Droplet={url:function(){throw new Error(A.URL_REQUIRED)},model:m,options:{},hooks:{},files:[],statusTypes:p,init:function(){var t=this;a(this,"files",[]);var e=l({},this.get("hooks"));a(this,"hooks",e);var i=l({},v);l(i,this.get("options")),a(this,"options",i),this.DropletEventBus&&this.DropletEventBus.subscribe(d,this,this._dropletBusAddFileHandler=function(e){for(var i=arguments.length,r=Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];e&&e!==t||t.send.apply(t,["prepareFiles"].concat(r))}),this._super()},willDestroy:function(){this._super(),this.DropletEventBus&&this.DropletEventBus.unsubscribe(d,this,this._dropletBusAddFileHandler);var t=this.get("lastRequest");t&&(delete t.upload.onprogress,delete t.upload.onload,delete t.upload.onerror,this.send("abortUpload"))},invokeHook:function(t){for(var i=this,r=arguments.length,n=Array(r>1?r-1:0),s=1;s<r;s++)n[s-1]=arguments[s];var a=o(this,"hooks")[t]||function(){};e.run(function(){return a.apply(i,n)})},uploadStatus:s(function(){return{uploading:!1,percentComplete:0,error:!1}}),validFiles:s.apply(void 0,_toConsumableArray(y).concat([function(){return this.getFiles(p.VALID)}])),invalidFiles:s.apply(void 0,_toConsumableArray(y).concat([function(){return this.getFiles(p.INVALID)}])),uploadedFiles:s.apply(void 0,_toConsumableArray(y).concat([function(){return this.getFiles(p.UPLOADED)}])),deletedFiles:s.apply(void 0,_toConsumableArray(y).concat([function(){return this.getFiles(p.DELETED)}])),requestSize:s.apply(void 0,_toConsumableArray(y).concat([function(){return o(this,"validFiles").reduce(function(t,e){return t+e.getFileSize()},0)}])),getFiles:function(t){return t?this.files.filter(function(e){return e.statusType&t}):this.files},isValid:function(t){var i=this;if(!(t instanceof e.Object))return!1;return function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];return function(t){return e.reverse().every(function(e){return e(t)})}}(function(t){return function(){var e=i.get("options.mimeTypes").some(function(t){return t instanceof RegExp}),r=o(i,"options.mimeTypes");return e?r.some(function(e){var i=e===t,r=!!t.match(e);return i||r}):!!~r.indexOf(t)}}(t.getMIMEType()),function(t){return function(){return t<=Number(o(i,"options.maximumSize"))}}(t.getFileSize()))(t)},getFormData:function(){var e=new t.FormData,i=this.get("options.useArray")?"file[]":"file",r=this.get("options.requestPostData");return o(this,"validFiles").map(function(t){return t.file}).forEach(function(t){e.append(i,t)}),Object.keys(r).forEach(function(t){e.append(t,r[t])}),e},addProgressListener:function(t){var e=this;t.addEventListener("progress",function(t){if(t.lengthComputable){var i=t.loaded/o(e,"requestSize")*100;a(e,"uploadStatus.percentComplete",Math.round(i))}})},getRequest:function(){var t=this,i=function(t){return"function"==typeof t}(o(this,"url"))?o(this,"url").apply(this):o(this,"url"),r=o(this,"options.requestMethod")||"POST",n=this.getFormData(),s=l({},this.get("options.requestHeaders"));o(this,"options.includeXFileSize")&&(s["X-File-Size"]=this.get("requestSize"));var u=e.$.ajax({url:i,method:r,headers:s,data:n,processData:!1,contentType:!1,xhr:function(){var i=e.$.ajaxSettings.xhr();return t.addProgressListener(i.upload),a(t,"lastRequest",i),i}});return a(this,"lastResolver",u),u},actions:{uploadFiles:function(){var t=this;this.invokeHook("beforeUpload");var i=o(this,"files").filter(function(t){return t.statusType&p.VALID}),r=this.getRequest();a(this,"abortedUpload",!1),a(this,"uploadStatus.percentComplete",0),a(this,"uploadStatus.uploading",!0),a(this,"uploadStatus.error",!1);var n=function(e,n){t.invokeHook("promiseResolver",e,n,i),r.done(e).fail(n)},s=function(e){t.invokeHook("didUpload",e),i.map(function(t){return t.setStatusType(p.UPLOADED)})},u=function(e){var i=e.request,r=e.textStatus,n=e.errorThrown;!0!==o(t,"abortedUpload")&&a(t,"uploadStatus.error",{request:i,textStatus:r,errorThrown:n}),t.invokeHook("rejected",i,r,n)},l=function(){a(t,"uploadStatus.uploading",!1),t.invokeHook("didComplete")};return new e.RSVP.Promise(n).then(s,u).finally(l)},abortUpload:function(){var t=o(this,"lastResolver");t&&o(this,"uploadStatus.uploading")&&(a(this,"abortedUpload",!0),t.abort(),a(this,"uploadStatus.uploading",!1))},mimeTypes:function(t){(arguments.length>1&&void 0!==arguments[1]?arguments[1]:g.PUSH)===g.SET&&a(this,"options.mimeTypes",[]),t=Array.isArray(t)?t:[t];var e=[].concat(_toConsumableArray(o(this,"options.mimeTypes")),_toConsumableArray(t));a(this,"options.mimeTypes",e)},addFiles:function(){for(var t=this,i=arguments.length,r=Array(i),n=0;n<i;n++)r[n]=arguments[n];var s=r.map(function(i){var r=t.get("validFiles.length")===t.get("options.maximumValidFiles");if(i instanceof e.Object){var n=t.isValid(i)&&!r?p.VALID:p.INVALID;return u(function(){return i.setStatusType(n)}),o(t,"files").pushObject(i),i}}).filter(function(t){return void 0!==t});s.length&&this.invokeHook.apply(this,["didAdd"].concat(_toConsumableArray(s))),this.get("options.uploadImmediately")&&this.getFiles(p.VALID).length>0&&this.send.apply(this,["uploadFiles"].concat(_toConsumableArray(s)))},prepareFiles:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];e=h(e);var r=e.reduce(function(t,e){var i=m.create({file:e});return t.push(i),t},[]);return this.send.apply(this,["addFiles"].concat(_toConsumableArray(r))),r},deleteFiles:function(){for(var t=this,e=arguments.length,i=Array(e),r=0;r<e;r++)i[r]=arguments[r];var n=i.map(function(e){if(!!~o(t,"files").indexOf(e))return e.setStatusType(p.DELETED),e}).filter(function(t){return void 0!==t});n.length&&this.invokeHook.apply(this,["didDelete"].concat(_toConsumableArray(n)))},clearFiles:function(){var t=this;[].concat(_toConsumableArray(this.get("validFiles")),_toConsumableArray(this.get("invalidFiles"))).forEach(function(e){return t.send("deleteFiles",e)})}}};var D=function(t){t.preventDefault(),t.stopPropagation()};t.Droplet.Area=r.create({classNames:["droppable"],drop:function(t){return D(t),this.handleFiles(t.dataTransfer.files)},handleFiles:function(t){var e;return this.DropletEventBus&&(e=this.DropletEventBus).publish.apply(e,[d,this.get("ctx")].concat(_toConsumableArray(h(t)))),t},dragEnter:D,dragOver:D,dragLeave:D}),t.Droplet.Preview=r.create({tagName:"img",attributeBindings:["src"],reader:i,image:{file:{type:""}},isImage:function(t){return!!t.type.match(/^image\//i)},didInsertElement:function(){var t=this,e=this.get("reader"),i=new e,r=o(this,"image.file");if(!this.isImage(r))return void this.destroy();i.addEventListener("load",u.bind(this,function(e){!0!==t.get("isDestroyed")&&a(t,"src",e.target.result)})),i.readAsDataURL(r)}}),t.Droplet.MultipleInput=r.create({tagName:"input",classNames:"files",attributeBindings:["disabled","name","type","multiple"],type:"file",multiple:"multiple",change:function(){var t=this.get("element").files;this.handleFiles(t)},handleFiles:function(t){var e;this.DropletEventBus&&(e=this.DropletEventBus).publish.apply(e,[d,this.get("ctx")].concat(_toConsumableArray(h(t))))}}),t.Droplet.SingleInput=r.create(t.Droplet.MultipleInput,{multiple:!1}),t.Droplet.METHOD=c}(window,window.Ember,window.FileReader);